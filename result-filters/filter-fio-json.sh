#!/bin/bash
# filter-fio-json.sh created 2024 by David Schmidt
# Usage: ./filter-fio-json.sh <node #> 
#
# This script is used to process the files generated by fio-full-[*].bat scripts 
# used for Windows VM performance testing. The fio-full-* scripts run a suite of 
# fio commands using blocksize={4k, 32k, 1M}, IO-depth={1, 4, 16}, numjob={1, 2, 
# 4, 8, 16}, and rw={ranread, ranwrite, read, write} and save the results into 
# json files with filenames of the form:
#   {rr, rw, sr, sw}-[BS]-iod[IOD]-fs[filesize]g-nj[num jobs].json. 
#
# This script should be run in a directory that contains all of the output files 
# from a given run. It greps for both "iops" and "bw" across all json files and 
# directs the output to a file with the name "node[$1]-{iops, bw}.txt. It then 
# processes each file to strip out quotes, extra spaces, colons, and commas. It 
# then renames the file identifier so that the file can be sorted  by BS and then 
# IOD. Commas are then added as a separator so that the output file can be easily 
# imported into a spreadsheet. 

if [[ $# -ne 1  ]]
then
   echo; echo "Incorrect number of parameters "
   echo "Usage: ./filter-fio-json.sh <node #> "; echo
   exit 1
fi

grep \"iops\" *.json |grep -v " 0.000" > node${1}-iops.txt
grep \"bw\" *.json |grep -v " 0," > node${1}-bw.txt

for i in iops bw
do
   sed -i "s/:        \"/ /g" node${1}-${i}.txt
   sed -i "s/\"/ /g" node${1}-${i}.txt
   sed -i "s/ : //g" node${1}-${i}.txt
   sed -i "s/,//g" node${1}-${i}.txt
   sed -i 's/iod1-/iod01-/g' node${1}-${i}.txt 
   sed -i 's/iod4-/iod04-/g' node${1}-${i}.txt
   sed -i 's/4k/1-4k/g' node${1}-${i}.txt
   sed -i 's/32k/2-32k/g' node${1}-${i}.txt
   sed -i 's/1M/3-1M/g' node${1}-${i}.txt
   sed -i 's/ /,/g' node${1}-${i}.txt
   cp node${1}-${i}.txt tmp.txt
   sort tmp.txt > node${1}-${i}.txt
done
rm -f tmp.txt

